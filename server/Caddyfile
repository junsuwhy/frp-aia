{
    # 填寫 Email 用於 Let's Encrypt 通知
    email {$EMAIL}
    
    # ✅ On-Demand TLS 配置 - 使用 Caddy 內部端點驗證（無需額外服務）
    on_demand_tls {
        ask http://127.0.0.1:2019/check
    }
}

# 內部驗證端點（只監聽 localhost，不對外開放）
:2019 {
    bind 127.0.0.1
    
    @valid_domain {
        # 允許主域名和所有子域名
        expression {query.domain} == "{$DOMAIN}" || {query.domain}.endsWith(".{$DOMAIN}")
    }
    
    handle @valid_domain {
        respond "OK" 200
    }
    
    handle {
        respond "Forbidden" 403
    }
}

# 主域名
{$DOMAIN} {
    respond "FRP Server is running - {$DOMAIN}" 200
}

# ⚠️ 具體的子域名要放在通配符之前！

# 你的 Dashboard 入口 (可選)
dashboard.{$DOMAIN} {
    reverse_proxy frps:7500 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# 安裝檔案下載端點（僅限指定 IP 訪問）
# 訪問方式：https://install.{$DOMAIN}/{$INSTALL_PATH}/install.sh
install.{$DOMAIN} {
    tls {
        on_demand
    }

    @allowed {
        remote_ip {$ALLOWED_IPS}
    }

    handle @allowed {
        # 提供 frpc-config.json（token 使用 base64 編碼）
        handle /{$INSTALL_PATH}/frpc-config.json {
            header Content-Type "application/json"
            @tokenEncoded expression `{http.request.uri.query.raw} == "true"`
            respond @tokenEncoded `{
  "server": "{$DOMAIN}",
  "token_encoded": "{$FRP_TOKEN_BASE64}"
}` 200
        }

        # 提供靜態檔案（install.sh, install.ps1, 二進位檔案）
        handle /{$INSTALL_PATH}/* {
            uri strip_prefix /{$INSTALL_PATH}
            root * /app/install-files
            file_server browse
        }

        # 根路徑提示
        handle {
            respond "Please access /{$INSTALL_PATH}/ for installation files" 200
        }
    }

    # ⚠️ 排除 ACME challenge 路徑，讓 Caddy 自動處理 Let's Encrypt 驗證
    @not_acme {
        not path /.well-known/acme-challenge/*
    }

    handle @not_acme {
        respond "Access Denied" 403
    }
}

# 匹配所有其他子網域（這個要放在最後！）
*.{$DOMAIN} {
    tls {
        on_demand
    }

    # 將流量轉給 frps 的 HTTP Port
    reverse_proxy frps:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
